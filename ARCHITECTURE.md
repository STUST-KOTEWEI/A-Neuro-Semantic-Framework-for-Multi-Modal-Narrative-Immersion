# CoreML 情緒分析架構圖

## 系統架構概覽

```
┌─────────────────────────────────────────────────────────────────────┐
│                          模型開發階段                                 │
│                         (離線處理)                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐          ┌──────────────┐                        │
│  │   訓練資料    │   訓練    │  情緒分析模型  │                        │
│  │  (文字+標籤)  │  ─────→  │ (PyTorch/TF)  │                        │
│  └──────────────┘          └──────────────┘                        │
│                                   │                                │
│                                   │ model.pt / model.h5            │
│                                   ↓                                │
│                     ┌────────────────────────┐                     │
│                     │ convert_emotion_model.py│                     │
│                     │   (轉換腳本)             │                     │
│                     └────────────────────────┘                     │
│                                   │                                │
│                                   │ EmotionLSTM.mlpackage          │
│                                   ↓                                │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ (部署到 iOS 專案)
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        iOS 應用程式運行時                              │
│                         (線上處理)                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐                                                  │
│  │  使用者介面   │                                                   │
│  │  (UI Layer)  │                                                   │
│  └──────┬───────┘                                                  │
│         │ 輸入文字                                                   │
│         ↓                                                          │
│  ┌─────────────────────────────────────────────┐                  │
│  │      EmotionAnalysisService.swift           │                  │
│  │         (業務邏輯層)                          │                  │
│  ├─────────────────────────────────────────────┤                  │
│  │                                             │                  │
│  │  ┌──────────────────────────────────────┐  │                  │
│  │  │  1. 預處理 (preprocess)              │  │                  │
│  │  │     ├─ tokenize()                    │  │                  │
│  │  │     ├─ vocabulary mapping            │  │                  │
│  │  │     ├─ padding/truncating            │  │                  │
│  │  │     └─ MLMultiArray 轉換             │  │                  │
│  │  └──────────────────────────────────────┘  │                  │
│  │                    ↓                        │                  │
│  │  ┌──────────────────────────────────────┐  │                  │
│  │  │  2. 模型推理 (predict)               │  │                  │
│  │  │     └─ CoreML.predict()              │  │                  │
│  │  └──────────────────────────────────────┘  │                  │
│  │                    ↓                        │                  │
│  │  ┌──────────────────────────────────────┐  │                  │
│  │  │  3. 後處理 (postprocess)             │  │                  │
│  │  │     ├─ 提取機率分佈                   │  │                  │
│  │  │     ├─ 找出最大機率                   │  │                  │
│  │  │     └─ 映射到情緒標籤                 │  │                  │
│  │  └──────────────────────────────────────┘  │                  │
│  │                                             │                  │
│  └─────────────────────────────────────────────┘                  │
│         │                                                          │
│         │ 返回情緒結果                                               │
│         ↓                                                          │
│  ┌──────────────┐                                                  │
│  │  使用者介面   │                                                   │
│  │  顯示結果     │                                                   │
│  └──────────────┘                                                  │
│                                                                     │
│  ┌─────────────────────────────────────────────┐                  │
│  │         CoreML Framework                     │                  │
│  │  ┌──────────────────────────────────────┐  │                  │
│  │  │    EmotionLSTM.mlpackage             │  │                  │
│  │  │  ┌────────────────────────────────┐  │  │                  │
│  │  │  │  Neural Engine / GPU / CPU     │  │  │                  │
│  │  │  └────────────────────────────────┘  │  │                  │
│  │  └──────────────────────────────────────┘  │                  │
│  └─────────────────────────────────────────────┘                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 資料流程詳解

### 輸入處理流程

```
使用者輸入: "I am so happy today!"
          ↓
┌─────────────────────────────────────┐
│  tokenize()                         │
│  ["I", "am", "so", "happy", "today"] │
└─────────────────────────────────────┘
          ↓
┌─────────────────────────────────────┐
│  vocabulary mapping                 │
│  [45, 12, 78, 23, 89]              │
└─────────────────────────────────────┘
          ↓
┌─────────────────────────────────────┐
│  padding to length 128              │
│  [45, 12, 78, 23, 89, 0, 0, ...]   │
└─────────────────────────────────────┘
          ↓
┌─────────────────────────────────────┐
│  MLMultiArray                       │
│  shape: [1, 128]                    │
│  dataType: int32                    │
└─────────────────────────────────────┘
```

### 模型推理流程

```
MLMultiArray 輸入
          ↓
┌─────────────────────────────────────┐
│  CoreML Model                       │
│  EmotionLSTM                        │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  Embedding Layer              │ │
│  │  [1, 128] → [1, 128, 64]     │ │
│  └───────────────────────────────┘ │
│              ↓                      │
│  ┌───────────────────────────────┐ │
│  │  LSTM Layer                   │ │
│  │  [1, 128, 64] → [1, 128]     │ │
│  └───────────────────────────────┘ │
│              ↓                      │
│  ┌───────────────────────────────┐ │
│  │  Fully Connected Layer        │ │
│  │  [1, 128] → [1, 5]           │ │
│  └───────────────────────────────┘ │
│              ↓                      │
│  ┌───────────────────────────────┐ │
│  │  Softmax                      │ │
│  │  機率分佈                      │ │
│  └───────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
          ↓
MLMultiArray 輸出: [0.85, 0.05, 0.03, 0.02, 0.05]
```

### 輸出處理流程

```
機率陣列: [0.85, 0.05, 0.03, 0.02, 0.05]
          ↓
┌─────────────────────────────────────┐
│  找出最大值索引                       │
│  max_index = 0                      │
└─────────────────────────────────────┘
          ↓
┌─────────────────────────────────────┐
│  映射到情緒標籤                       │
│  emotionLabels[0] = "joy"           │
└─────────────────────────────────────┘
          ↓
最終結果: "joy" (置信度: 85%)
```

## 類別結構

### EmotionAnalysisService 類別圖

```
┌──────────────────────────────────────────┐
│      EmotionAnalysisService              │
├──────────────────────────────────────────┤
│  屬性 (Properties):                      │
│  - model: MLModel?                       │
│  - emotionLabels: [String]               │
│  - maxSequenceLength: Int                │
│  - vocabulary: [String: Int]             │
├──────────────────────────────────────────┤
│  私有方法 (Private Methods):              │
│  - loadModel()                           │
│  - setupVocabulary()                     │
│  - tokenize(text: String) -> [String]    │
│  - preprocess(text: String) -> MLMultiArray? │
│  - predict(input: MLMultiArray) -> MLFeatureProvider? │
│  - postprocess(output: MLFeatureProvider?) -> String │
├──────────────────────────────────────────┤
│  公開 API (Public API):                  │
│  - analyze(text: String) -> String       │
│  - analyzeWithConfidence(text: String) -> [String: Double] │
└──────────────────────────────────────────┘
```

## 檔案依賴關係

```
使用者應用程式
    │
    ├─→ EmotionAnalysisService.swift
    │       │
    │       ├─→ CoreML Framework
    │       │       │
    │       │       └─→ EmotionLSTM.mlpackage
    │       │
    │       └─→ Foundation Framework
    │
    └─→ emotion_analysis_example.swift (範例參考)
```

## 轉換工具依賴

```
convert_emotion_model.py
    │
    ├─→ coremltools
    │       │
    │       └─→ CoreML 轉換引擎
    │
    ├─→ PyTorch (可選)
    │       │
    │       └─→ torch.jit.trace
    │
    └─→ TensorFlow (可選)
            │
            └─→ keras.models.load_model
```

## 執行環境

### 開發環境

```
┌─────────────────────────────────────┐
│  開發者機器 (macOS/Linux/Windows)    │
├─────────────────────────────────────┤
│                                     │
│  Python 3.7+                        │
│  ├─ coremltools                     │
│  ├─ PyTorch / TensorFlow            │
│  └─ convert_emotion_model.py        │
│                                     │
│  輸出: EmotionLSTM.mlpackage        │
│                                     │
└─────────────────────────────────────┘
```

### 生產環境

```
┌─────────────────────────────────────┐
│  iOS 裝置 (iPhone/iPad)              │
├─────────────────────────────────────┤
│                                     │
│  iOS 15.0+                          │
│  ├─ CoreML Framework                │
│  ├─ Neural Engine                   │
│  ├─ EmotionLSTM.mlpackage          │
│  └─ EmotionAnalysisService.swift   │
│                                     │
│  即時情緒分析                        │
│                                     │
└─────────────────────────────────────┘
```

## 效能考量

### 硬體加速層級

```
優先順序 (由高到低):

1. Neural Engine    ⚡⚡⚡
   - 最快
   - 最省電
   - 專門為 ML 設計

2. GPU             ⚡⚡
   - 較快
   - 適合並行處理

3. CPU             ⚡
   - 最慢
   - 適合小型模型
   - 通用處理
```

### 記憶體使用

```
組件                     記憶體佔用
─────────────────────────────────
模型本身 (.mlpackage)    ~2-10 MB
運行時模型實例           ~5-20 MB
輸入 MLMultiArray        ~0.5 KB
輸出 MLMultiArray        ~20 bytes
詞彙表                   ~10-50 KB
─────────────────────────────────
總計 (約)                ~7-30 MB
```

## 錯誤處理流程

```
analyze(text: String)
    │
    ├─→ 檢查輸入文字
    │   └─→ 空字串? → 返回 "unknown"
    │
    ├─→ preprocess()
    │   └─→ 失敗? → 返回 nil → 返回 "unknown"
    │
    ├─→ predict()
    │   └─→ 模型未載入? → 返回 nil → 返回 "unknown"
    │   └─→ 預測失敗? → 返回 nil → 返回 "unknown"
    │
    └─→ postprocess()
        └─→ 輸出格式錯誤? → 返回 "unknown"
        └─→ 成功 → 返回情緒標籤
```

## 擴展點

系統提供以下擴展點供客製化：

1. **詞彙表** (`setupVocabulary`)
   - 替換為訓練時使用的詞彙表
   - 支援多語言

2. **分詞器** (`tokenize`)
   - 自訂分詞邏輯
   - 整合第三方分詞庫

3. **情緒標籤** (`emotionLabels`)
   - 自訂情緒類別
   - 調整數量

4. **序列長度** (`maxSequenceLength`)
   - 調整以匹配模型
   - 權衡速度與準確度

5. **模型配置** (`MLModelConfiguration`)
   - 指定計算單元
   - 設定批次大小

---

**版本：** 1.0.0  
**更新日期：** 2025-10-12
